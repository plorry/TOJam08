/*     
  Canvas Query 0.6.5
  http://canvasquery.org
  (c) 2012-2013 http://rezoner.net
  Canvas Query may be freely distributed under the MIT license.
*/

(function(h){h.requestAnimationFrame=h.requestAnimationFrame||h.webkitRequestAnimationFrame||h.mozRequestAnimationFrame||h.oRequestAnimationFrame||h.msRequestAnimationFrame||function(a){h.setTimeout(a,1E3/60)};var d=function(a){if(0===arguments.length){var c=d.createCanvas(h.innerWidth,h.innerHeight);h.addEventListener("resize",function(){c.width=h.innerWidth;c.height=h.innerHeight})}else if("string"===typeof a)c=d.createCanvas(document.querySelector(a)[0]);else if("number"===typeof a)c=d.createCanvas(arguments[0],
arguments[1]);else if(a instanceof Image)c=d.createCanvas(a);else if(a instanceof HTMLCanvasElement)c=a;else if(a instanceof d.Wrapper)return a;return new d.Wrapper(c)};d.extend=function(){for(var a=1;a<arguments.length;a++)for(var c in arguments[a])arguments[0][c]=arguments[a][c];return arguments[0]};d.augment=function(){for(var a=1;a<arguments.length;a++)_.extend(arguments[0],arguments[a]),arguments[a](arguments[0])};d.extend(d,{keycodes:{37:"left",38:"up",39:"right",40:"down",45:"insert",46:"delete",
8:"backspace",9:"tab",13:"enter",16:"shift",17:"ctrl",18:"alt",19:"pause",20:"capslock",27:"escape",32:"space",33:"pageup",34:"pagedown",35:"end",112:"f1",113:"f2",114:"f3",115:"f4",116:"f5",117:"f6",118:"f7",119:"f8",120:"f9",121:"f10",122:"f11",123:"f12",144:"numlock",145:"scrolllock",186:"semicolon",187:"equal",188:"comma",189:"dash",190:"period",191:"slash",192:"graveaccent",219:"openbracket",220:"backslash",221:"closebraket",222:"singlequote"},cleanArray:function(a,c){for(var b=arguments[arguments.length-
1],e="function"===typeof b,d=0,f=a.length;d<f;d++)if(null===a[d]||c&&a[d][c])e&&b(a[d]),a.splice(d--,1),f--},specialBlendFunctions:["color","value","hue","saturation"],blendFunctions:{normal:function(a,c){return c},overlay:function(a,c){a/=255;c/=255;return Math.min(255,Math.max(0,255*(128>a?2*a*c:1-2*(1-a)*(1-c))|0))},hardLight:function(a,c){return d.blendFunctions.overlay(c,a)},softLight:function(a,c){a/=255;c/=255;return d.limitValue(255*((1-2*c)*a*a+2*c*a),0,255)},dodge:function(a,c){return 256*
a/(255-c+1)},burn:function(a,c){return 255-256*(255-a)/(c+1)},multiply:function(a,c){return c*a/255},divide:function(a,c){return d.limitValue(256*a/(c+1),0,255)},screen:function(a,c){return 255-(255-c)*(255-a)/255},grainExtract:function(a,c){return d.limitValue(a-c+128,0,255)},grainMerge:function(a,c){return d.limitValue(a+c-128,0,255)},difference:function(a,c){return Math.abs(a-c)},addition:function(a,c){return Math.min(a+c,255)},substract:function(a,c){return Math.max(a-c,0)},darkenOnly:function(a,
c){return Math.min(a,c)},lightenOnly:function(a,c){return Math.max(a,c)},color:function(a,c){var b=d.rgbToHsl(a),e=d.rgbToHsl(c);return d.hslToRgb(e[0],e[1],b[2])},hue:function(a,c){var b=d.rgbToHsv(a),e=d.rgbToHsv(c);return e[1]?d.hsvToRgb(e[0],b[1],b[2]):d.hsvToRgb(b[0],b[1],b[2])},value:function(a,c){var b=d.rgbToHsv(a),e=d.rgbToHsv(c);return d.hsvToRgb(b[0],b[1],e[2])},saturation:function(a,c){var b=d.rgbToHsv(a),e=d.rgbToHsv(c);return d.hsvToRgb(b[0],e[1],b[2])}},blend:function(a,c,b,e){"undefined"===
typeof e&&(e=1);a=d(a);c=d(c);var j=c.context,f=a.context.getImageData(0,0,a.canvas.width,a.canvas.height);c=j.getImageData(0,0,c.canvas.width,c.canvas.height);f=f.data;c=c.data;var j=this.createImageData(a.canvas.width,a.canvas.height),g=j.data,k=d.blendFunctions[b];if(-1!==d.specialBlendFunctions.indexOf(b)){b=0;for(var l=f.length;b<l;b+=4){var h=k([f[b+0],f[b+1],f[b+2]],[c[b+0],c[b+1],c[b+2]]);g[b+0]=f[b+0]+(h[0]-f[b+0])*e;g[b+1]=f[b+1]+(h[1]-f[b+1])*e;g[b+2]=f[b+2]+(h[2]-f[b+2])*e;g[b+3]=f[b+
3]}}else{b=0;for(l=f.length;b<l;b+=4){var h=k(f[b+0],c[b+0]),m=k(f[b+1],c[b+1]),n=k(f[b+2],c[b+2]);g[b+0]=f[b+0]+(h-f[b+0])*e;g[b+1]=f[b+1]+(m-f[b+1])*e;g[b+2]=f[b+2]+(n-f[b+2])*e;g[b+3]=f[b+3]}}a.context.putImageData(j,0,0);return a},wrapValue:function(a,c,b){a<c?a=b+(a-c):a>b&&(a=c+(a-b));return a},limitValue:function(a,c,b){return a<c?c:a>b?b:a},mix:function(a,c,b){return a+(c-a)*b},hexToRgb:function(a){return["0x"+a[1]+a[2]|0,"0x"+a[3]+a[4]|0,"0x"+a[5]+a[6]|0]},rgbToHex:function(a,c,b){return"#"+
(16777216+(a<<16)+(c<<8)+b).toString(16).slice(1,7)},rgbToHsl:function(a,c,b){a instanceof Array&&(b=a[2],c=a[1],a=a[0]);a/=255;c/=255;b/=255;var e=Math.max(a,c,b),d=Math.min(a,c,b),f,g=(e+d)/2;if(e==d)f=d=0;else{var k=e-d,d=0.5<g?k/(2-e-d):k/(e+d);switch(e){case a:f=(c-b)/k+(c<b?6:0);break;case c:f=(b-a)/k+2;break;case b:f=(a-c)/k+4}f/=6}return[f,d,g]},hslToRgb:function(a,c,b){if(0==c)b=c=a=b;else{var e=function(a,b,c){0>c&&(c+=1);1<c&&(c-=1);return c<1/6?a+6*(b-a)*c:0.5>c?b:c<2/3?a+6*(b-a)*(2/3-
c):a},d=0.5>b?b*(1+c):b+c-b*c,f=2*b-d;b=e(f,d,a+1/3);c=e(f,d,a);a=e(f,d,a-1/3)}return[255*b|0,255*c|0,255*a|0]},rgbToHsv:function(a,c,b){a instanceof Array&&(b=a[2],c=a[1],a=a[0]);a/=255;c/=255;b/=255;var e=Math.max(a,c,b),d=Math.min(a,c,b),f,g=e-d;if(e==d)f=0;else{switch(e){case a:f=(c-b)/g+(c<b?6:0);break;case c:f=(b-a)/g+2;break;case b:f=(a-c)/g+4}f/=6}return[f,0==e?0:g/e,e]},hsvToRgb:function(a,c,b){var e,d,f,g=Math.floor(6*a),k=6*a-g;a=b*(1-c);var h=b*(1-k*c);c=b*(1-(1-k)*c);switch(g%6){case 0:e=
b;d=c;f=a;break;case 1:e=h;d=b;f=a;break;case 2:e=a;d=b;f=c;break;case 3:e=a;d=h;f=b;break;case 4:e=c;d=a;f=b;break;case 5:e=b,d=a,f=h}return[255*e,255*d,255*f]},color:function(){var a=new d.Color;a.parse(arguments);return a},createCanvas:function(a,c){var b=document.createElement("Canvas");a instanceof Image?(b.width=a.width,b.height=a.height,b.getContext("2d").drawImage(a,0,0)):(b.width=a,b.height=c);return b},createImageData:function(a,c){return document.createElement("Canvas").getContext("2d").createImageData(a,
c)},mousePosition:function(a){var c=0,b=0,e=a.srcElement,d=0,f=0;do c+=e.offsetLeft,b+=e.offsetTop;while(e=e.offsetParent);if(a.pageX||a.pageY)d=a.pageX,f=a.pageY;else if(a.clientX||a.clientY)d=a.clientX+document.body.scrollLeft+document.documentElement.scrollLeft,f=a.clientY+document.body.scrollTop+document.documentElement.scrollTop;return{x:d-c,y:f-b}}});d.Wrapper=function(a){this.context=a.getContext("2d");this.canvas=a};d.Wrapper.prototype={appendTo:function(a){("object"===typeof a?a:document.querySelector(a)).appendChild(this.canvas);
return this},blendOn:function(a,c,b){d.blend(a,this,c,b);return this},blend:function(a,c,b){if("string"===typeof a){var e=a;a=d(d.createCanvas(this.canvas.width,this.canvas.height));a.fillStyle(e).fillRect(0,0,this.canvas.width,this.canvas.height)}d.blend(this,a,c,b);return this},crop:function(a,c,b,e){this.context.drawImage(this.canvas,a,c,b,e,0,0,b,e);this.canvas.width=b;this.canvas.height=e;return this},set:function(a){d.extend(this.context,a)},resize:function(a,c){var b=d(a,c).drawImage(this.canvas,
0,0,this.canvas.width,this.canvas.height,0,0,a,c);this.canvas=b.canvas;this.context=b.context;return this},matchPalette:function(a){for(var c=this.context.getImageData(0,0,this.canvas.width,this.canvas.height),b=[],e=0;e<a.length;e++)b.push(d.color(a[e]));for(e=0;e<c.data.length;e+=4){for(var j=[],f=0;f<b.length;f++){var g=b[f],k=Math.abs(c.data[e]-g[0]),h=Math.abs(c.data[e+1]-g[1]),g=Math.abs(c.data[e+2]-g[2]);j.push(k+h+g)}for(f=k=0;f<a.length;f++)j[f]<j[k]&&(k=f);j=cq.hexToRgb(a[k]);c.data[e]=
j[0];c.data[e+1]=j[1];c.data[e+2]=j[2]}this.context.putImageData(c,0,0);return this},getPalette:function(){for(var a=[],c=this.context.getImageData(0,0,this.canvas.width,this.canvas.height).data,b=0,e=c.length;b<e;b+=4)if(c[b+3]){var j=d.rgbToHex(c[b+0],c[b+1],c[b+2]);-1===a.indexOf(j)&&a.push(j)}return a},pixelize:function(a){if(!a)return this;var c=this.context.mozImageSmoothingEnabled,b=this.context.webkitImageSmoothingEnabled;this.context.mozImageSmoothingEnabled=!1;this.context.webkitImageSmoothingEnabled=
!1;a=this.canvas.width/(a||4)/this.canvas.width;var e=cq(this.canvas.width,this.canvas.height);e.drawImage(this.canvas,0,0,this.canvas.width,this.canvas.height,0,0,this.canvas.width*a|0,this.canvas.height*a|0);this.clear().drawImage(e.canvas,0,0,this.canvas.width*a|0,this.canvas.height*a|0,0,0,this.canvas.width,this.canvas.height);this.context.mozImageSmoothingEnabled=c;this.context.webkitImageSmoothingEnabled=b;return this},colorToMask:function(a){a=d.color(a).toArray();for(var c=this.context.getImageData(0,
0,this.canvas.width,this.canvas.height).data,b=[],e=0,j=c.length;e<j;e+=4)c[e+0]==a[0]&&c[e+1]==a[1]&&c[e+2]==a[2]?b.push(!1):b.push(!0);return b},grayscaleToMask:function(a){d.color(a).toArray();a=this.context.getImageData(0,0,this.canvas.width,this.canvas.height).data;for(var c=[],b=0,e=a.length;b<e;b+=4)c.push((a[b+0]+a[b+1]+a[b+2])/3|0);return c},applyMask:function(a){for(var c=this.context.getImageData(0,0,this.canvas.width,this.canvas.height),b=c.data,e="boolean"===typeof a[0]?"bool":"byte",
d=0,f=b.length;d<f;d+=4){var g=a[d/4];b[d+3]="boolean"===e?255*g|0:g|0}this.context.putImageData(c,0,0);return this},fillMask:function(a){var c=this.context.getImageData(0,0,this.canvas.width,this.canvas.height),b=c.data,e="boolean"===typeof a[0]?"bool":"byte",j=2===arguments.length?"normal":"gradient",f=d.color(arguments[1]);"gradient"===j&&(colorB=d.color(arguments[2]));for(var g=0,h=b.length;g<h;g+=4){var l=a[g/4];"byte"===e&&(l/=255);"normal"===j?l&&(b[g+0]=f[0]|0,b[g+1]=f[1]|0,b[g+2]=f[2]|0,
b[g+3]=255*l|0):(b[g+0]=f[0]+(colorB[0]-f[0])*l|0,b[g+1]=f[1]+(colorB[1]-f[1])*l|0,b[g+2]=f[2]+(colorB[2]-f[2])*l|0,b[g+3]=255)}this.context.putImageData(c,0,0);return this},clear:function(a){a?(this.context.fillStyle=a,this.context.fillRect(0,0,this.canvas.width,this.canvas.height)):this.context.clearRect(0,0,this.canvas.width,this.canvas.height);return this},clone:function(){var a=d.createCanvas(this.canvas.width,this.canvas.height);a.getContext("2d").drawImage(this.canvas,0,0);return d(a)},fillStyle:function(a){this.context.fillStyle=
a;return this},strokeStyle:function(a){this.context.strokeStyle=a;return this},setHsl:function(){var a=1===arguments.length?arguments[0]:arguments,c=this.context.getImageData(0,0,this.canvas.width,this.canvas.height),b=c.data,e,j,f;f=[];e=[];for(var g=0,h=b.length;g<h;g+=4)f=d.rgbToHsl(b[g+0],b[g+1],b[g+2]),e=null===a[0]?f[0]:d.limitValue(a[0],0,1),j=null===a[1]?f[1]:d.limitValue(a[1],0,1),f=null===a[2]?f[2]:d.limitValue(a[2],0,1),e=d.hslToRgb(e,j,f),b[g+0]=e[0],b[g+1]=e[1],b[g+2]=e[2];this.context.putImageData(c,
0,0);return this},shiftHsl:function(){var a=1===arguments.length?arguments[0]:arguments,c=this.context.getImageData(0,0,this.canvas.width,this.canvas.height),b=c.data,e,j,f;f=[];e=[];for(var g=0,h=b.length;g<h;g+=4)f=d.rgbToHsl(b[g+0],b[g+1],b[g+2]),e=null===a[0]?f[0]:d.wrapValue(f[0]+a[0],0,1),j=null===a[1]?f[1]:d.limitValue(f[1]+a[1],0,1),f=null===a[2]?f[2]:d.limitValue(f[2]+a[2],0,1),e=d.hslToRgb(e,j,f),b[g+0]=e[0],b[g+1]=e[1],b[g+2]=e[2];this.context.putImageData(c,0,0);return this},convolve:function(a,
c,b){"undefined"===typeof b&&(b=1);"undefined"===typeof c&&(c=1);for(var e=this.context.getImageData(0,0,this.canvas.width,this.canvas.height),j=Math.sqrt(a.length)+0.5|0,f=j/2|0,g=e.data,h=e.width,e=e.height,l=d.createImageData(this.canvas.width,this.canvas.height),m=l.data,n=1;n<e-1;n++)for(var p=1;p<h-1;p++){for(var q=4*(n*h+p),v=0,w=0,x=0,t=0;t<j;t++)for(var u=0;u<j;u++){var r=n+t-f,s=p+u-f;0<=r&&(r<e&&0<=s&&s<h)&&(r=4*(r*h+s),s=a[t*j+u]/b,v+=g[r+0]*s,w+=g[r+1]*s,x+=g[r+2]*s)}m[q+0]=d.mix(g[q+
0],v,c);m[q+1]=d.mix(g[q+1],w,c);m[q+2]=d.mix(g[q+2],x,c);m[q+3]=g[q+3]}this.context.putImageData(l,0,0);return this},blur:function(a){return this.convolve([1,1,1,1,1,1,1,1,1],a,9)},gaussianBlur:function(a){return this.convolve([6.7E-7,2.292E-5,1.9117E-4,3.8771E-4,1.9117E-4,2.292E-5,6.7E-7,2.292E-5,7.8633E-4,0.00655965,0.01330373,0.00655965,7.8633E-4,2.292E-5,1.9117E-4,0.00655965,0.05472157,0.11098164,0.05472157,0.00655965,1.9117E-4,3.8771E-4,0.01330373,0.11098164,0.22508352,0.11098164,0.01330373,
3.8771E-4,1.9117E-4,0.00655965,0.05472157,0.11098164,0.05472157,0.00655965,1.9117E-4,2.292E-5,7.8633E-4,0.00655965,0.01330373,0.00655965,7.8633E-4,2.292E-5,6.7E-7,2.292E-5,1.9117E-4,3.8771E-4,1.9117E-4,2.292E-5,6.7E-7],a,1)},sharpen:function(a){return this.convolve([0,-1,0,-1,5,-1,0,-1,0],a)},threshold:function(a){for(var c=this.context.getImageData(0,0,this.canvas.width,this.canvas.height),b=c.data,e,d,f,g=0;g<b.length;g+=4)e=b[g],d=b[g+1],f=b[g+2],b[g]=b[g+1]=b[g+2]=0.2126*e+0.7152*d+0.0722*f>=
a?255:0;this.context.putImageData(c,0,0);return this},sepia:function(){for(var a=this.context.getImageData(0,0,this.canvas.width,this.canvas.height),c=a.data,b=0;b<c.length;b+=4)c[b+0]=d.limitValue(0.393*c[b+0]+0.769*c[b+1]+0.189*c[b+2],0,255),c[b+1]=d.limitValue(0.349*c[b+0]+0.686*c[b+1]+0.168*c[b+2],0,255),c[b+2]=d.limitValue(0.272*c[b+0]+0.534*c[b+1]+0.131*c[b+2],0,255);this.context.putImageData(a,0,0);return this},onStep:function(a,c){var b=this,d=Date.now();this.timer=setInterval(function(){var c=
Date.now()-d;a.call(b,c);d=Date.now()},c);return this},onRender:function(a){function c(){requestAnimationFrame(c);a.call(b)}var b=this;requestAnimationFrame(c);return this},onMouseMove:function(a){var c=this;this.canvas.addEventListener("mousemove",function(b){b=d.mousePosition(b);a.call(c,b.x,b.y)});this.canvas.addEventListener("touchmove",function(b){b=d.mousePosition(b);a.call(c,b.x,b.y)});return this},onMouseDown:function(a){var c=this;this.canvas.addEventListener("mousedown",function(b){var e=
d.mousePosition(b);a.call(c,e.x,e.y,b.button)});this.canvas.addEventListener("touchstart",function(b){b=d.mousePosition(b);a.call(c,b.x,b.y)});return this},onMouseUp:function(a){var c=this;this.canvas.addEventListener("mouseup",function(b){var e=d.mousePosition(b);a.call(c,e.x,e.y,b.button)});this.canvas.addEventListener("touchend",function(b){b=d.mousePosition(b);a.call(c,b.x,b.y)});return this},onKeyDown:function(a){document.addEventListener("keydown",function(c){c=48<=c.which&&90>=c.which?String.fromCharCode(c.which).toLowerCase():
d.keycodes[c.which];a.call(self,c)});return this},onKeyUp:function(a){document.addEventListener("keyup",function(c){c=48<=c.which&&90>=c.which?String.fromCharCode(c.which).toLowerCase():d.keycodes[c.which];a.call(self,c)});return this},onResize:function(a){var c=this;h.addEventListener("resize",function(){a.call(c,h.innerWidth,h.innerHeight)});a.call(c,h.innerWidth,h.innerHeight);return this},onDropImage:function(a){var c=this;document.addEventListener("drop",function(b){b.stopPropagation();b.preventDefault();
b=b.dataTransfer.files[0];if(!/image/i.test(b.type))return!1;var d=new FileReader;d.onload=function(b){var d=new Image;d.onload=function(){a.call(c,this)};d.src=b.target.result};d.readAsDataURL(b)});document.addEventListener("dragover",function(a){a.preventDefault()});return this}};for(var p="arc arcTo beginPath bezierCurveTo clearRect clip closePath createImageData createLinearGradient createRadialGradient createPattern drawFocusRing drawImage fill fillRect fillText getImageData isPointInPath lineTo measureText moveTo putImageData quadraticCurveTo rect restore rotate save scale setTransform stroke strokeRect strokeText transform translate".split(" "),
m=0;m<p.length;m++){var n=p[m];d.Wrapper.prototype[n]=Function("this.context."+n+".apply(this.context, arguments); return this;")}p="canvas fillStyle font globalAlpha globalCompositeOperation lineCap lineJoin lineWidth miterLimit shadowOffsetX shadowOffsetY shadowBlur shadowColor strokeStyle textAlign textBaseline".split(" ");for(m=0;m<p.length;m++)n=p[m],d.Wrapper.prototype[n]=Function("if(arguments.length) { this.context."+n+" = arguments[0]; return this; } else { return this.context."+n+"; }");
d.Color=function(){arguments.length&&this.parse(arguments)};d.Color.prototype={parse:function(a){if("string"===typeof a[0]){var c=d.hexToRgb(a[0]);this[0]=c[0];this[1]=c[1];this[2]=c[2];this[3]="undefined"===typeof a[1]?1:a[1]}else this[0]=a[0],this[1]=a[1],this[2]=a[2],this[3]="undefined"===typeof a[3]?1:a[3]},toArray:function(){return[this[0],this[1],this[2],this[3]]},toRgb:function(){return"rgb("+this[0]+", "+this[1]+", "+this[2]+")"},toRgba:function(){return"rgb("+this[0]+", "+this[1]+", "+this[2]+
", "+this[3]+")"},toHex:function(){return d.rgbToHex(this[0],this[1],this[2])},toHsl:function(){return d.rgbToHsl(this[0],this[1],this[2])},toHsv:function(){return d.rgbToHsv(this[0],this[1],this[2])}};h.cq=h.CanvasQuery=d;"function"===typeof define&&define.amd&&define([],function(){return d})})(window);